rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar si es administrador
    function isAdmin() {
      return request.auth != null && 
        request.auth.token.email in [
          'admin@glambook.com',
          'jadermonsalve9@gmail.com'
        ];
    }
    
    // Función helper para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función helper para verificar propietario
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // === USUARIOS ===
    // Los usuarios solo pueden leer/escribir sus propios datos
    match /usuarios/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Administradores pueden gestionar todos los usuarios
    match /usuarios/{document} {
      allow read, write: if isAdmin();
      
      // Usuarios autenticados pueden leer información básica (para búsquedas)
      allow read: if isAuthenticated() && 
        resource.data.keys().hasAny(['nombre', 'avatar', 'rol']);
    }
    
    // === CITAS ===
    match /citas/{citaId} {
      // Propietario puede leer/escribir sus citas
      allow read, write: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.data.userId == request.auth.uid
      );
      
      // Administradores pueden gestionar todas las citas  
      allow read, write: if isAdmin();
      
      // Crear cita requiere estar autenticado
      allow create: if isAuthenticated() && 
        request.data.userId == request.auth.uid;
    }
    
    // === TESTIMONIOS ===
    match /testimonios/{testimonioId} {
      // Lectura pública para testimonios aprobados
      allow read: if resource.data.estado == 'aprobado';
      
      // Los usuarios pueden crear sus propios testimonios
      allow create: if isAuthenticated() && 
        request.data.userId == request.auth.uid;
      
      // Solo el propietario puede editar testimonios pendientes
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        resource.data.estado == 'pendiente';
        
      // Administradores pueden gestionar todos los testimonios
      allow read, write: if isAdmin();
    }
    
    // === CONFIGURACIÓN DEL SISTEMA ===
    match /configuracion/{configId} {
      // Solo administradores pueden modificar configuración
      allow read, write: if isAdmin();
      
      // Lectura pública para configuración básica (horarios, servicios)
      allow read: if configId in ['horarios', 'servicios', 'precios'];
    }
    
    // === ESTADÍSTICAS Y REPORTES ===
    match /reportes/{reporteId} {
      // Solo administradores pueden acceder a reportes
      allow read, write: if isAdmin();
    }
    
    // === NOTIFICACIONES ===
    match /notificaciones/{notificacionId} {
      // Los usuarios pueden leer sus propias notificaciones
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Administradores pueden gestionar todas las notificaciones
      allow read, write: if isAdmin();
      
      // Sistema puede crear notificaciones
      allow create: if isAuthenticated();
    }
    
    // === LOGS DE AUDITORÍA ===
    match /logs/{logId} {
      // Solo administradores pueden ver logs
      allow read: if isAdmin();
      
      // Solo el sistema puede escribir logs
      allow create: if isAuthenticated();
    }
  }
}